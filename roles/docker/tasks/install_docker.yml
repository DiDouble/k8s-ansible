- name: install docker
  yum:
    name: docker-ce-{{docker_version}}
    state: present

- name: update docker service file
  shell: |
    sed -i '/#BEGIN --generated by kubernetes/,/#END --generated by kubernetes/d' /usr/lib/systemd/system/docker.service

- name: check docker forward
  shell: "grep  'FORWARD' /usr/lib/systemd/system/docker.service"
  register: forward_check
  ignore_errors: True
  failed_when: forward_check.rc >= 1

- name: enable docker forward
  shell: |
    sed -i '/\[Service\]/aExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT' /usr/lib/systemd/system/docker.service
  when: forward_check.rc >= 1

- name: set docker proxy
  shell: |
    sed  -i '/\[Service\]/a#END --generated by kubernetes' /usr/lib/systemd/system/docker.service
    sed  -i '/\[Service\]/aEnvironment="NO_PROXY={{docker_no_proxy}}"' /usr/lib/systemd/system/docker.service
    sed  -i '/\[Service\]/aEnvironment="HTTP_PROXY={{docker_proxy_url}}"' /usr/lib/systemd/system/docker.service
    sed  -i '/\[Service\]/aEnvironment="HTTPS_PROXY={{docker_proxy_url}}"' /usr/lib/systemd/system/docker.service
    sed  -i '/\[Service\]/a#BEGIN --generated by kubernetes' /usr/lib/systemd/system/docker.service
  when: docker_access_google == 'true'

- name: start docker and enable docker
  systemd:
    name: docker
    state: started
    daemon_reload: yes
    enabled: yes
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'